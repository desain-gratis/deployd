services:
  deployd1:
    image: deployd:latest
    restart: on-failure
    # env_file: ".env"
    environment:
      CONFIG: /etc/deployd/local-1.yml
      DC: "/etc/dragonboat.yaml"
      TZ: Asia/Jakarta
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/dbus/system_bus_socket"
      DEPLOYD_SECRET: /etc/deployd/local.yml.secret
      DEPLOYD_REPLICA_ID: 1
      DEPLOYD_HOSTNAME: deployd1
      DEPLOYD_OS: linux
      DEPLOYD_ARCH: amd64
    ports:
      - "9401:9600"
    volumes:
      - ./config/deployd:/etc/deployd
      - ./config/deployd/raft/config-1.yaml:/etc/dragonboat.yaml
      - ./www:/var/www
      - ./tmp1/data/data-1:/data
      - ./tmp1/dbus:/dbus
      - ./tmp1/etc:/etc
      - ./tmp1/opt:/opt
      - ./tmp1/tmp/:/tmp
      - ./tmp1/systemd/:/etc/systemd/system/
    depends_on:
      - clickhouse-deployd1
      - mock-systemd1
    networks:
      - docker-dev_appnet
    command: ["./deployd"]
  deployd2:
    image: deployd:latest
    restart: on-failure
    # env_file: ".env"
    environment:
      CONFIG: /etc/deployd/local-2.yml
      DC: "/etc/dragonboat.yaml"
      TZ: Asia/Jakarta
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/dbus/system_bus_socket"
      DEPLOYD_SECRET: /etc/deployd/local.yml.secret
      DEPLOYD_REPLICA_ID: 2
      DEPLOYD_HOSTNAME: deployd2
      DEPLOYD_OS: linux
      DEPLOYD_ARCH: amd64
    ports:
      - "9402:9600"
    volumes:
      - ./config/deployd:/etc/deployd
      - ./config/deployd/raft/config-2.yaml:/etc/dragonboat.yaml
      - ./www:/var/www
      - ./tmp2/data/data-2:/data
      - ./tmp2/dbus:/dbus
      - ./tmp2/etc:/etc
      - ./tmp2/opt:/opt
      - ./tmp2/tmp/:/tmp
      - ./tmp2/systemd/:/etc/systemd/system/
    depends_on:
      - clickhouse-deployd2
      - mock-systemd2
    networks:
      - docker-dev_appnet
    command: ["./deployd"]
  deployd3:
    image: deployd:latest
    restart: on-failure
    # env_file: ".env"
    environment:
      CONFIG: /etc/deployd/local-3.yml
      DC: "/etc/dragonboat.yaml"
      TZ: Asia/Jakarta
      DBUS_SYSTEM_BUS_ADDRESS: "unix:path=/dbus/system_bus_socket"
      DEPLOYD_SECRET: /etc/deployd/local.yml.secret
      DEPLOYD_REPLICA_ID: 3
      DEPLOYD_HOSTNAME: deployd3
      DEPLOYD_OS: linux
      DEPLOYD_ARCH: amd64
    ports:
      - "9403:9600"
    volumes:
      - ./config/deployd:/etc/deployd
      - ./config/deployd/raft/config-3.yaml:/etc/dragonboat.yaml
      - ./www:/var/www
      - ./tmp3/data/data-3:/data
      - ./tmp3/dbus:/dbus
      - ./tmp3/etc:/etc
      - ./tmp3/opt:/opt
      - ./tmp3/tmp/:/tmp
      - ./tmp3/systemd/:/etc/systemd/system/
    depends_on:
      - clickhouse-deployd3
      - mock-systemd3
    networks:
      - docker-dev_appnet
    command: ["./deployd"]

  clickhouse-deployd1:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-deployd1
    restart: on-failure
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: default
    ports:
      - "8801:8123"
      - "9901:9000"
    volumes:
      - ./tmp/data/clickhouse_data_deployd1:/var/lib/clickhouse
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - docker-dev_appnet # you need to create docker-dev folder with compose file in itfor the minio
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    deploy:
      resources:
        limits:
          memory: 2G # Sets a memory limit of 1 Gigabyte
        reservations:
          memory: 1G

  clickhouse-deployd2:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-deployd2
    restart: on-failure
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: default
    ports:
      - "8802:8123"
      - "9902:9000"
    volumes:
      - ./tmp/data/clickhouse_data_deployd2:/var/lib/clickhouse
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - docker-dev_appnet
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    deploy:
      resources:
        limits:
          memory: 2G # Sets a memory limit of 1 Gigabyte
        reservations:
          memory: 1G

  clickhouse-deployd3:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-deployd3
    restart: on-failure
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: default
    ports:
      - "8803:8123"
      - "9903:9000"
    volumes:
      - ./tmp/data/clickhouse_data_deployd3:/var/lib/clickhouse
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - docker-dev_appnet
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    deploy:
      resources:
        limits:
          memory: 2G # Sets a memory limit of 1 Gigabyte
        reservations:
          memory: 1G

  clickhouse-content:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-content
    restart: on-failure
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: default
    ports:
      - "8804:8123"
      - "9904:9000"
    volumes:
      - ./tmp/data/clickhouse_data_content:/var/lib/clickhouse
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - docker-dev_appnet
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    deploy:
      resources:
        limits:
          memory: 2G # Sets a memory limit of 1 Gigabyte
        reservations:
          memory: 1G

  mock-systemd1:
    image: ghcr.io/balena-os/mock-systemd-bus@sha256:79b92200fb6481edfea9776a75d6bf3fd8583b79b7e83868f49ba7b295f397ce
    # Necessary to run systemd in a container
    privileged: true
    volumes:
      - ./tmp1/dbus:/shared/dbus
    environment:
      # Set this variable with the location of your shared bus socket
      # NOTE: do not use /run/dbus as this path is overwritten by systemd
      # Pinned for reproducibility https://github.com/balena-os/mock-systemd-bus/pkgs/container/mock-systemd-bus
      DBUS_SYSTEM_BUS_ADDRESS: unix:path=/shared/dbus/system_bus_socket
      # Optionally set-up any mock units you need. Service files for these
      # Will be created on service start
      # Because the mock does not support creation using .service file, we put it here (so it always be there)
      MOCK_SYSTEMD_UNITS: fakemill.service deployd_user-profile.service

  mock-systemd2:
    image: ghcr.io/balena-os/mock-systemd-bus@sha256:79b92200fb6481edfea9776a75d6bf3fd8583b79b7e83868f49ba7b295f397ce
    # Necessary to run systemd in a container
    privileged: true
    volumes:
      - ./tmp2/dbus:/shared/dbus
    environment:
      # Set this variable with the location of your shared bus socket
      # NOTE: do not use /run/dbus as this path is overwritten by systemd
      # Pinned for reproducibility https://github.com/balena-os/mock-systemd-bus/pkgs/container/mock-systemd-bus
      DBUS_SYSTEM_BUS_ADDRESS: unix:path=/shared/dbus/system_bus_socket
      # Optionally set-up any mock units you need. Service files for these
      # Will be created on service start
      MOCK_SYSTEMD_UNITS: fakemill.service deployd_user-profile.service

  mock-systemd3:
    image: ghcr.io/balena-os/mock-systemd-bus@sha256:79b92200fb6481edfea9776a75d6bf3fd8583b79b7e83868f49ba7b295f397ce
    # Necessary to run systemd in a container
    privileged: true
    volumes:
      - ./tmp3/dbus:/shared/dbus
    environment:
      # Set this variable with the location of your shared bus socket
      # NOTE: do not use /run/dbus as this path is overwritten by systemd
      # Pinned for reproducibility https://github.com/balena-os/mock-systemd-bus/pkgs/container/mock-systemd-bus
      DBUS_SYSTEM_BUS_ADDRESS: unix:path=/shared/dbus/system_bus_socket
      # Optionally set-up any mock units you need. Service files for these
      # Will be created on service start
      MOCK_SYSTEMD_UNITS: fakemill.service deployd_user-profile.service

volumes:
  config:
    driver: local

networks:
  docker-dev_appnet:
    external: true
