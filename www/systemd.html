<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<title>DBus Monitor</title>
</head>

<body class="bg-gray-100 p-3">

<h1 class="text-xl font-bold mb-3">Systemd Services</h1>

<input id="search" type="text"
  placeholder="Search services..."
  class="w-full p-2 rounded border mb-3" />

<div id="list" class="space-y-2"></div>

<script>
/* -----------------------------------------------------
   STATE (Fast lookup maps)
----------------------------------------------------- */
const services = {};       // key → data
const elements = {};       // key → DOM row

/* -----------------------------------------------------
   WEBSOCKET
----------------------------------------------------- */
const ws = new WebSocket("ws://localhost:9999/ws");

ws.onmessage = (event) => {
  let msg;
  try { msg = JSON.parse(event.data); } catch { return }

  if (!msg.key || !msg.data) return;

  updateService(msg.key, msg.data);
};

/* -----------------------------------------------------
   DOM UPDATE (ultra fast)
----------------------------------------------------- */
function updateService(key, data) {
  services[key] = data;

  if (elements[key]) {
    updateRow(elements[key], data);
  } else {
    const el = createRow(key, data);
    elements[key] = el;
    document.getElementById("list").appendChild(el);
  }

  applySearch();
}

/* -----------------------------------------------------
   ELEMENT TEMPLATES
----------------------------------------------------- */
function createRow(key, data) {
  const wrapper = document.createElement("div");
  wrapper.className = "bg-white rounded shadow";

  wrapper.innerHTML = `
    <button class="w-full flex justify-between p-3 text-left font-semibold">
      <span class="service-name"></span>
      <span class="badge text-white text-xs px-2 py-1 rounded"></span>
    </button>

    <div class="details hidden px-3 pb-3 text-sm space-y-1">
      <div><b>Description:</b> <span class="desc"></span></div>
      <div><b>Load:</b> <span class="load"></span></div>
      <div><b>Active:</b> <span class="active"></span></div>
      <div><b>Sub:</b> <span class="sub"></span></div>

      <div class="mt-2 flex gap-2">
        <button class="start px-3 py-1 bg-green-600 text-white rounded text-xs">Start</button>
        <button class="stop px-3 py-1 bg-red-600 text-white rounded text-xs">Stop</button>
      </div>
    </div>
  `;

  const btn = wrapper.querySelector("button");
  const details = wrapper.querySelector(".details");
  btn.onclick = () => { details.classList.toggle("hidden") };

  wrapper.querySelector(".start").onclick = () => sendAction("start", key);
  wrapper.querySelector(".stop").onclick = () => sendAction("stop", key);

  updateRow(wrapper, data);
  return wrapper;
}

function updateRow(el, d) {
  el.querySelector(".service-name").textContent = d.name;
  el.querySelector(".desc").textContent = d.description;
  el.querySelector(".load").textContent = d.load_state;
  el.querySelector(".active").textContent = d.active_state;
  el.querySelector(".sub").textContent = d.sub_state;

  const badge = el.querySelector(".badge");
  badge.textContent = d.active_state;

  badge.className = "badge text-white text-xs px-2 py-1 rounded";

  if (d.active_state === "active") badge.classList.add("bg-green-600");
  else if (d.active_state === "failed") badge.classList.add("bg-red-600");
  else badge.classList.add("bg-gray-600");
}

/* -----------------------------------------------------
   SEND ACTION (no server echo expected)
----------------------------------------------------- */
function sendAction(action, key) {
  ws.send(JSON.stringify({
    name: "dbus",
    data: { action, unit: key }
  }));
}

/* -----------------------------------------------------
   SEARCH (fast debounce)
----------------------------------------------------- */
let searchTimer = null;

document.getElementById("search").addEventListener("input", () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(applySearch, 100);
});

function applySearch() {
  const q = document.getElementById("search").value.toLowerCase();

  for (const key in elements) {
    const match =
      key.toLowerCase().includes(q) ||
      services[key].name.toLowerCase().includes(q);

    elements[key].style.display = match ? "block" : "none";
  }
}
</script>
</body>
</html>
